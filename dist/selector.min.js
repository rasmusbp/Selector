(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports):typeof define==="function"&&define.amd?define(["exports"],e):e(t.StatefulSelector=t.StatefulSelector||{})})(this,function(t){"use strict";function e(t){return!Array.isArray(t)?[t]:t.reduce((t,n)=>[...t,...e(n)],[])}var n={NOT_EXIST:t=>`${t} --> item does not exist.`,ALREADY_EXIST:t=>`${t} --> item already exist.`,READ_ONLY:t=>`${t} --> ${t} is a read only property`,ALREADY_SELECTED:t=>`${t} --> item is already selected.`,NOT_SELECTED:t=>`${t} --> item is not selected.`,INVALID_TYPE:t=>`${t} --> item must be of same type.`,INVALID_STATE:t=>`${t} --> provided state is not valid. 
                    Make sure to provide valid 'items' and 'selections' arrays.`};class s{constructor({message,reason,data}){this.message=message;this.reason=reason;this.data=data}print(t){switch(t.level){case"throw":throw new Error(this.message);case"error":console.error(this.message,this.data);break;case"warn":console.warn(this.message,this.data);break;case"log":console.log(this.message,this.data);break;case"silent":break;default:console.log(this.message,this.data);break}return this}}const r=new WeakMap;const i="added";const o="removed";const c="selected";const u="deSelected";class a{constructor(t={items:[],selections:[]},e){const i=new Map;const o=new Map;const c=new Set;const u=Object.assign({trackBy:undefined,strict:false,debug:false,validators:[()=>true],providers:Object.assign({Error:s},e.providers)},e);u.logLevel=u.strict?"error":"warn";function a({reason,data,context="Selector"}){const t=n[reason]||(()=>"null");const e=u.providers.Error;return new e({message:`Selector@${t(context)}`,reason:reason,data:data})}function f(t){const e=u.providers.Error;const n=Object.keys(t).reduce((n,s)=>{return[...n,...t[s].filter(t=>t instanceof e)]},[]);return n.length?n:undefined}function l(t,e){const n=e.errors||[];if(u.strict&&n.length){return n}return e.items.reduce((e,n)=>{const s=A(n);t.set(s,n);return[...e,n]},[])}function h(t,e){const n=e.errors||[];if(u.strict&&n.length){return n}return e.items.reduce((e,n)=>{const s=A(n);const r=t.delete(s);return r?[...e,n]:e},[])}function d(t){const e=u.strict&&f(t);c.forEach(n=>{const s=[t,this.state,this];if(e){n.error(e,...s);return}n.success(...s)})}function g(t){return i.get(A(t))}function m(t){return i.has(A(t))}function S(t){return o.has(A(t))}function p(t,e=u.logLevel){if(u.strict||u.debug){t.forEach(t=>t.print({level:e}))}}const v={all:{validate:t=>t},existing:{validate:g},adding:{iterator(t,e){return e(t)},validate(t,e){return!m(t)?t:a({reason:"ALREADY_EXIST",data:t,context:e})}},getting:{validate(t,e){return m(t)?g(t):a({reason:"NOT_EXIST",data:t,context:e})}},selecting:{validate(t,e){if(!m(t)){return a({reason:"NOT_EXIST",data:t,context:e})}else if(S(t)){return a({reason:"ALREADY_SELECTED",data:g(t),context:e})}else{return g(t)}}},deSelecting:{validate(t,e){if(!m(t)){return a({reason:"NOT_EXIST",data:t,context:e})}else if(!S(t)){return a({reason:"NOT_SELECTED",data:g(t),context:e})}else{return g(t)}}}};function E(t){if(Array.isArray(t)){return t}return typeof t==="function"?t:[t]}function b(t,e){if(!e)return t;if(e instanceof u.providers.Error){t.errors.push(e)}else{t.items.push(e)}return t}function y(t,e,n){const s=E(e);const r={items:[],errors:[]};if(typeof s!=="function"){return s.reduce((e,s)=>{return b(e,t.validate(s,n))},r)}const i=s;if(t.iterator){return t.validate(t.iterator(this.state,i)).reduce(b,r)}return this.state.items.reduce((e,s,r)=>{if(i(s,r)===true){return b(e,t.validate(s,n))}return e},r)}function A(t){const{trackBy}=u;if(!trackBy||typeof t!=="object"&&t!==null){return t}if(typeof trackBy==="function"){return trackBy(t)}return t[trackBy]}function T(t){if(!t)return false;return[typeof t==="object",Array.isArray(t.items),Array.isArray(t.selections)].every(t=>t)}function w(t,e){const n=()=>{return a({reason:"INVALID_STATE",context:e,data:t}).print({level:"throw"})};if(!t){n()}if(Array.isArray(t)){return{get:()=>({items:t,selections:[]})}}return{get:T(t)?()=>t:n}}r.set(this,{log:p,config:u,itemsMap:i,resolverFor:v,resolveInput:E,subscriptions:c,selectionsMap:o,lastChange:undefined,resolveItemsWith:y.bind(this),createStateError:a.bind(this),createStateGetter:w.bind(this),operators:{has:m.bind(this),get:g.bind(this),isSelected:S.bind(this),addTo:l.bind(this),removeFrom:h.bind(this),dispatch:d.bind(this)}});r.get(this).initialStateGetter=w.call(this,t,"initialStateGetter");const{initialStateGetter}=r.get(this);this.setState(initialStateGetter.get())}static mirror(t){return{[i]:(t[o]||[]).slice(0),[o]:(t[i]||[]).slice(0),[c]:(t[u]||[]).slice(0),[u]:(t[c]||[]).slice(0)}}subscribe(t,e){const{subscriptions}=r.get(this);const n={success:t,error:e};subscriptions.add(n);return()=>{subscriptions.delete(n);return this}}select(t){return this.bulk({[c]:t})}deSelect(t){return this.bulk({[u]:t})}selectAll(){return this.deSelectAll().select(this.state.items)}deSelectAll(){return this.deSelect(this.state.selections)}invert(){return this.toggle(this.state.items)}toggle(t){const n=e([t]).reduce((t,e)=>{if(this.isSelected(e)){t[u].push(e)}else{t[c].push(e)}return t},{[c]:[],[u]:[]});return this.bulk(n)}add(t){return this.bulk({[i]:t})}remove(t){return this.bulk({[o]:t})}removeAll(){return this.remove(this.state.items)}reset(){const{initialStateGetter}=r.get(this);return this.setState(initialStateGetter.get())}isSelected(t){const{resolveItemsWith,resolverFor,operators,log}=r.get(this);if(!this.hasSelections)return false;const e=resolveItemsWith(resolverFor.getting,t,"isSelected");log(e.errors,"warn");return e.items.every(operators.isSelected)}isSomeSelected(t){const{resolveItemsWith,resolverFor,operators,log}=r.get(this);if(!this.hasSelections)return false;const e=resolveItemsWith(resolverFor.getting,t,"isSomeSelected");log(e.errors,"warn");return e.items.some(operators.isSelected)}isOnlySelected(t){const{resolveItemsWith,resolverFor,operators,log}=r.get(this);if(!this.hasSelections)return false;const e=resolveItemsWith(resolverFor.getting,t,"isOnlySelected");log(e.errors,"warn");return Boolean(e.items.length)&&e.items.every(operators.isSelected)&&this.state.selections.length===e.items.length}has(t){const{resolveItemsWith,resolverFor,operators}=r.get(this);const e=resolveItemsWith(resolverFor.all,t);return Boolean(e.items.length)&&e.items.every(operators.has)}hasSome(t){const{resolveItemsWith,resolverFor}=r.get(this);const e=resolveItemsWith(resolverFor.getting,t);return Boolean(e.items.length)}swap(t,e){const{operators,itemsMap,selectionsMap,resolveItemsWith,resolveKey}=r.get(this);if(!this.has(t)){throw new Error(`Selector#swap -> cannot swap non-existing item`)}const n=resolveItemsWith(t)[0];const s=resolveKey(t);if(this.isSelected(n)){selectionsMap.set(s,e)}itemsMap.set(s,e);operators.dispatch({[i]:[itemsMap.get(s)],[o]:[n]});return this}setState(t){const{state}=this;const{log,operators,resolveItemsWith,resolverFor,config,itemsMap,selectionsMap,createStateGetter}=r.get(this);const e=createStateGetter(t,"setState").get();const n=operators.removeFrom(selectionsMap,{items:state.items});const s=operators.removeFrom(itemsMap,{items:state.items});const i=operators.addTo(itemsMap,{items:e.items});const o=resolveItemsWith(resolverFor.selecting,e.selections,"selections@setState");log(o.errors);const c=operators.addTo(selectionsMap,o);operators.dispatch({deSelected:n,selected:c,removed:s,added:i});return this}bulk(t){const{log,config,operators,resolveItemsWith,resolverFor,resolveInput,itemsMap,selectionsMap}=r.get(this);const e=[i,c,o,u];const n=e.reduce((e,n)=>{if(!t[n]&&t[n]!==0){return e}const s={[o]:()=>{const n=resolveItemsWith(resolverFor.getting,t[o],o);log(n.errors);n.items.forEach(t=>{if(this.isSelected(t)){e[u].push(...operators.removeFrom(selectionsMap,{items:[t]}))}});e[o]=operators.removeFrom(itemsMap,n)},[u]:()=>{const n=resolveItemsWith(resolverFor.deSelecting,t[u],u);log(n.errors);e[u].push(...operators.removeFrom(selectionsMap,n))},[i]:()=>{const n=resolveItemsWith(resolverFor.adding,t[i],i);log(n.errors);e[i]=operators.addTo(itemsMap,n)},[c]:()=>{const n=resolveItemsWith(resolverFor.selecting,t[c],c);log(n.errors);e[c]=operators.addTo(selectionsMap,n)}};s[n]();return e},{[i]:[],[c]:[],[u]:[],[o]:[]});const s=Object.keys(n).some(t=>!!n[t].length);if(s){operators.dispatch(n)}return this}undoLast(){const{lastChange}=r.get(this);this.bulk(a.mirror(lastChange))}unsubscribeAll(){const{subscriptions}=r.get(this);subscriptions.clear();return this}get state(){const{selectionsMap,itemsMap}=r.get(this);return{items:Array.from(itemsMap.values()),selections:Array.from(selectionsMap.values())}}get hasSelections(){const{selectionsMap}=r.get(this);return Boolean(selectionsMap.size)}get hasItems(){const{itemsMap}=r.get(this);return Boolean(itemsMap.size)}get isAllSelected(){return this.isSelected(this.state.items)}get isValid(){const{validators}=r.get(this).config;return validators.every(t=>t(this.state,this))}}function f(t,e={}){return new a(t,e)}const l={createSelector:f,Selector:a};t["default"]=l;t.createSelector=f;t.Selector=a;Object.defineProperty(t,"__esModule",{value:true})});