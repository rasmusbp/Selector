(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports):typeof define==="function"&&define.amd?define(["exports"],e):e(t.StatefulSelector=t.StatefulSelector||{})})(this,function(t){"use strict";class e{constructor(t,...e){this.message=t;this.args=[...e]}print({level}){switch(level){case"throw":throw new Error(this.message+JSON.stringify(this.args));case"soft_throw":console.error(this.message,...this.args);break;case"warn":console.warn(this.message,...this.args);break;case"log":console.log(this.message,...this.args);break;default:console.log(this.message,...this.args);break}return this}}var n={NO_ITEM:t=>`${t} --> item does not exist.`,ALREADY_EXIST:t=>`${t} --> item already exist.`,ALREADY_SELECTED:t=>`${t} --> item is already selected.`,ALREADY_DESELECTED:t=>`${t} --> item is already deselected.`,INVALID_TYPE:t=>`${t} --> item must be of same type.`,INVALID_OBSERVER:()=>`subscribe --> observer is not a function.`,INVALID_STATE:t=>`${t} --> provided state is not valid. 
                    Make sure to provide valid 'items' and 'selections' arrays.`};class s{constructor(t,e){this.error=new Error(t);this.item=e}}function r(t){return!Array.isArray(t)?[t]:t.reduce((t,e)=>[...t,...r(e)],[])}function i({err,details=undefined,strict=true,context="Selector"}){const t=n[err]||(()=>"null");return new e(`Selector@${t(context)}`,details)}function o(t){const e=Object.keys(t).reduce((e,n)=>{return[...e,...t[n].filter(t=>t instanceof s)]},[]);return e.length?e:undefined}function c(t,e){const{itemsMap,resolveKey}=e;return itemsMap.has(resolveKey(t))}function u(t,e){const{selectionsMap,resolveKey}=e;if(selectionsMap.size===0)return false;return t.every(t=>selectionsMap.has(resolveKey(t)))}function f(t,e){const{selectionsMap,resolveKey}=e;if(selectionsMap.size===0)return false;return t.some(t=>selectionsMap.has(resolveKey(t)))}function a(t,e,n){const{resolveKey,config}=n;return e.reduce((e,n)=>{if(n instanceof s){e.push(n);return e}const r=resolveKey(n);const i=!t.has(r);if(i){t.set(r,n);e.push(n)}return e},[])}function h(t,e,n){const{resolveKey,config}=n;return e.reduce((e,n)=>{if(n instanceof s){e.push(n);return e}const r=resolveKey(n);const i=t.delete(r);if(i){e.push(n)}return e},[])}function l(t,e,n){const{subscriptions,noopChanges,config}=n;const s=config.strict&&o(t);subscriptions.forEach(n=>{const r=[Object.assign(noopChanges,t),e,this];if(s){n.error(s,...r);return}n.success(...r)})}function d(t,e,n){const{itemsMap}=n;if(typeof t==="function"){const e=t;return this.state.items.reduce((t,n,s)=>{if(e(n,s)===true){t.push(n)}return t},[])}const{resolveKey,config}=n;const o=r([t]);const c=t=>{return t.reduce((t,n)=>{const r=resolveKey(n);const o=itemsMap.has(r);if(!o&&config.strict){const r=i({err:"NO_ITEM",context:e,details:n});r.print({level:"warn"});t.push(new s(r.message,n))}else{t.push(itemsMap.get(r))}return t},[])};return c(o)}function g(t,e){const{trackBy}=e.config;if(!trackBy||typeof t!=="object"&&t!==null){return t}if(typeof trackBy==="function"){return trackBy(t)}return t[trackBy]}function m(t,e){if(!t){i({err:"INVALID_STATE",context:e}).print({level:"throw"})}if(Array.isArray(t)){return{get:()=>({items:t,selections:[]})}}const n=()=>[typeof t==="object",Array.isArray(t.items),Array.isArray(t.selections)].every(t=>t);if(!n()){return{get:()=>i({err:"INVALID_STATE",context:e}).print({level:"throw"})}}return{get:()=>t}}const p=new WeakMap;const S="added";const E="removed";const v="selected";const A="deSelected";class y{constructor(t={items:[],selections:[]},e={}){p.set(this,{initialStateGetter:m(t,"initialStateGetter"),itemsMap:new Map,selectionsMap:new Map,subscriptions:new Set,get noopChanges(){return{[S]:[],[v]:[],[A]:[],[E]:[]}},createStateGetter:m.bind(this),resolveItems:(t,e)=>d(t,e,p.get(this)),resolveKey:t=>g(t,p.get(this)),operators:{has:t=>c(t,p.get(this)),addTo:(t,e)=>a(t,e,p.get(this)),removeFrom:(t,e)=>h(t,e,p.get(this)),dispatch:t=>{l(t,this.state,p.get(this))},isSelected:t=>u(t,p.get(this)),isSomeSelected:t=>f(t,p.get(this))},config:Object.assign({trackBy:undefined,strict:true,validators:[()=>true],serializer:t=>t},e)});const{initialStateGetter}=p.get(this);this.setState(initialStateGetter.get())}subscribe(t,e){const{subscriptions}=p.get(this);if(!t||typeof t!=="function"||e&&typeof e!=="function"){i({err:"INVALID_OBSERVER"}).print({level:"throw"})}const n={success:t,error:e};subscriptions.add(n);return()=>{subscriptions.delete(n);return this}}select(t){return this.patch({[v]:t})}deSelect(t){return this.patch({[A]:t})}selectAll(t){return this.deSelectAll().select(this.state.items)}deSelectAll(){return this.deSelect(this.state.selections)}invert(){return this.toggle(this.state.items)}toggle(t){const e=r([t]).reduce((t,e)=>{if(this.isSelected(e)){t[A].push(e)}else{t[v].push(e)}return t},{[v]:[],[A]:[]});return this.patch(e)}add(t){return this.patch({[S]:r([t])})}remove(t){return this.patch({[E]:t})}removeAll(){return this.remove(this.state.items)}reset(){const{initialStateGetter}=p.get(this);return this.setState(initialStateGetter.get())}isOnlySelected(t){const{operators,resolveItems:resolveItems$$1}=p.get(this);const e=resolveItems$$1(t,"isOnlySelected");return operators.isSelected(e)&&this.state.selections.length===e.length}isSelected(t){const{operators,resolveItems:resolveItems$$1}=p.get(this);return operators.isSelected(resolveItems$$1(t,"isSelected"))}isSomeSelected(t){const{operators,resolveItems:resolveItems$$1}=p.get(this);return operators.isSomeSelected(resolveItems$$1(t,"isSomeSelected"))}has(t){const{operators,resolveItems:resolveItems$$1}=p.get(this);return operators.has(resolveItems$$1(t,"has")[0])}swap(t,e){const{operators,itemsMap,selectionsMap,resolveItems:resolveItems$$1,resolveKey:resolveKey$$1}=p.get(this);if(!this.has(t)){throw new Error(`Selector#swap -> cannot swap non-existing item`)}const n=resolveItems$$1(t)[0];const s=resolveKey$$1(t);if(this.isSelected(n)){selectionsMap.set(s,e)}itemsMap.set(s,e);operators.dispatch({[S]:[itemsMap.get(s)],[E]:[n]});return this}setState(t){const{state}=this;const{operators,resolveItems:resolveItems$$1,itemsMap,selectionsMap,createStateGetter:createStateGetter$$1}=p.get(this);const e=createStateGetter$$1(t,"setState").get();const n=operators.removeFrom(selectionsMap,state.items);const s=operators.removeFrom(itemsMap,state.items);const r=operators.addTo(itemsMap,e.items);const i=operators.addTo(selectionsMap,resolveItems$$1(e.selections,"setState"));operators.dispatch({deSelected:n,selected:i,removed:s,added:r});return this}patch(t){const{operators,resolveItems:resolveItems$$1,itemsMap,selectionsMap,noopChanges,config}=p.get(this);const e=[S,v,E,A];const n=Object.assign(noopChanges,t);const s="warn";const r=e.reduce((t,e)=>{switch(e){case E:t[E]=operators.removeFrom(itemsMap,resolveItems$$1(n[E],E));break;case A:const r=resolveItems$$1(n[A],A).map(t=>{if(!config.strict||operators.isSelected([t]))return t;return i({err:"ALREADY_DESELECTED",context:A,details:t}).print({level:s})});t[A]=operators.removeFrom(selectionsMap,r);break;case S:const o=n[S].map(t=>{if(!config.strict||!operators.has(t))return t;return i({err:"ALREADY_EXIST",context:S,details:t}).print({level:s})});t[S]=operators.addTo(itemsMap,o);break;case v:const c=resolveItems$$1(n[v],v).map(t=>{if(!config.strict||!operators.isSelected([t]))return t;return i({err:"ALREADY_SELECTED",context:v,details:t}).print({level:s})});t[v]=operators.addTo(selectionsMap,c);break;default:break}return t},{});const o=Object.keys(r).some(t=>r[t].length);if(o){operators.dispatch(r)}return this}replay(t){t.forEach(t=>this.patch(t));return this}unsubscribeAll(){const{subscriptions}=p.get(this);subscriptions.clear();return this}serialize(...t){const{serializer}=p.get(this).config;return serializer(this.state.selections,...t)}get state(){const{selectionsMap,itemsMap}=p.get(this);return{items:Array.from(itemsMap.values()),selections:Array.from(selectionsMap.values())}}get hasSelections(){const{selectionsMap}=p.get(this);return Boolean(selectionsMap.size)}get isAllSelected(){return this.isSelected(this.state.items)}get isValid(){const{validators}=p.get(this).config;return validators.every(t=>t(this.state.selections))}}function I(t,e=undefined){return new y(t,e)}t.createSelector=I;t["default"]=y;Object.defineProperty(t,"__esModule",{value:true})});